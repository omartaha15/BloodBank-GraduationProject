name: Build & Deploy ‚Äì bloodbank-managementsystem

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PUBLISH_DIR: ./publish        # folder we‚Äôll create

jobs:
  build:
    runs-on: windows-latest
    permissions: { contents: read }

    steps:
    - uses: actions/checkout@v4

    - name: Set up .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'

    # üëâ build the *solution* (fixes ‚ÄúMSB1003‚Äù)
    - name: Build
      run: dotnet build "Blood Bank/BloodBank.sln" -c Release

    # üëâ publish **only the web project** (replace path if different)
    - name: Publish
      run: |
        dotnet publish "Blood Bank/BloodBank.Web/BloodBank.Web.csproj" `
                       -c Release -o ${{ env.PUBLISH_DIR }}
        Compress-Archive -Path ${{ env.PUBLISH_DIR }}\* `
                         -DestinationPath ${{ env.PUBLISH_DIR }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: publish-zip
        path: ${{ env.PUBLISH_DIR }}.zip

  deploy:
    runs-on: windows-latest
    needs: build
    environment: Production
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: publish-zip

    - name: Azure login
      uses: azure/login@v2
      with:
        client-id:      ${{ secrets.AZUREAPPSERVICE_CLIENTID_‚Ä¶ }}
        tenant-id:      ${{ secrets.AZUREAPPSERVICE_TENANTID_‚Ä¶ }}
        subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_‚Ä¶ }}

    - name: Deploy to Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: bloodbank-managementsystem
        package: publish.zip           # ‚Üê exact file we built
